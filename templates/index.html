<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Thi·∫øt B·ªã</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #145a32 0%, #1e8449 50%, #27ae60 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #145a32 0%, #1e8449 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-container {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .logo-container i {
            font-size: 40px;
            color: #27ae60;
        }

        .logo-text h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .logo-text p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* Responsive cho 5 cards - hi·ªÉn th·ªã ƒë·∫πp h∆°n */
        @media (min-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @media (min-width: 768px) and (max-width: 1199px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .stat-card-icon.blue { background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); }
        .stat-card-icon.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card-icon.orange { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .stat-card-icon.purple { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }

        .stat-card-icon i {
            color: white;
            font-size: 28px;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #145a32 0%, #1e8449 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #7f8c8d;
            font-weight: 500;
        }

        /* Filter Section - VIP Pro Style */
        .filter-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            border: 1px solid rgba(30, 132, 73, 0.1);
            position: relative;
            overflow: hidden;
        }

        .filter-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #2980b9 0%, #3498db 50%, #11998e 100%);
        }

        .filter-section h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-section h3 i {
            color: #2980b9;
            font-size: 1.8rem;
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-advanced-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }

        .advanced-toggle {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .advanced-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 132, 73, 0.4);
        }

        .advanced-filters {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .advanced-filters.show {
            max-height: 500px;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: block;
        }

        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #2980b9;
            box-shadow: 0 0 0 0.2rem rgba(41, 128, 185, 0.25);
        }

        .btn-filter {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            align-self: end;
            box-shadow: 0 4px 15px rgba(41, 128, 185, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-filter::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-filter:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-filter:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(41, 128, 185, 0.5);
        }

        .btn-filter:active {
            transform: translateY(-1px);
        }

        .btn-group-custom {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
            align-items: stretch;
            justify-content: flex-start;
            margin-top: 20px;
        }
        
        @media (max-width: 992px) {
            .btn-group-custom {
                flex-wrap: wrap;
            }
        }

        .btn-group-custom .btn,
        .btn-group-custom .advanced-toggle {
            border-radius: 25px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            white-space: nowrap;
            flex-shrink: 0;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .btn-group-custom .btn:hover,
        .btn-group-custom .advanced-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn-group-custom .btn i,
        .btn-group-custom .advanced-toggle i {
            font-size: 1rem;
        }

        .select-custom {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        .select-custom:focus {
            border-color: #2980b9;
            box-shadow: 0 0 0 0.2rem rgba(41, 128, 185, 0.25);
            outline: none;
        }

        /* Results Section */
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .results-header h3 {
            color: #2c3e50;
            font-weight: 700;
            margin: 0;
        }

        .results-count {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            margin: 0;
            width: 100%;
        }

        .table thead {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            color: white;
        }

        .table thead th {
            border: none;
            padding: 15px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #e8e8e8;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .badge-custom {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .badge-custom.primary {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            color: white;
        }

        .badge-custom.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .no-results i {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .no-results h4 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2980b9;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Image Preview */
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        /* Image Modal */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .image-modal-content {
            position: relative;
            background: white;
            border-radius: 15px;
            padding: 15px;
            width: 800px;
            min-height: 600px;
            max-width: 90vw;
            max-height: 90vh;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .image-modal-title {
            color: #27ae60;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .image-modal-close {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        .image-modal-close:hover {
            transform: scale(1.1);
            background: #c0392b;
        }

        .image-modal-body {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 550px;
            flex: 1;
            min-height: 550px;
        }

        .image-modal-body img {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .image-modal-footer {
            text-align: center;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
            width: 100%;
            flex-shrink: 0;
        }

        .image-modal-footer p {
            color: #7f8c8d;
            font-size: 0.75rem;
            word-break: break-all;
            margin-bottom: 8px;
        }

        .image-modal-footer a {
            color: #27ae60;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .image-modal-footer a:hover {
            color: #1e8449;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo-section {
                flex-direction: column;
                text-align: center;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .btn-filter {
                width: 100%;
                align-self: stretch;
            }

            .image-modal-content {
                width: 95vw;
                min-height: 400px;
            }

            .image-modal-body {
                height: 350px;
                min-height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="logo-section" style="flex: 1;">
                    <h1 style="font-size: 2.5rem; font-weight: 700; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">H·ªá Th·ªëng Qu·∫£n L√Ω Thi·∫øt B·ªã</h1>
                    <p style="font-size: 1.1rem; opacity: 0.9; margin: 10px 0 0 0;">Dashboard Qu·∫£n L√Ω</p>
                </div>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-card-icon blue">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <h3><span id="todayRecords">0</span> / <span id="totalRecords">0</span></h3>
                <p>T·ªïng s·ªë ghi h√¥m nay / T·ªïng s·ªë ghi</p>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon green">
                    <i class="fas fa-car"></i>
                </div>
                <h3 id="uniquePlates">0</h3>
                <p>Bi·ªÉn s·ªë kh√°c nhau</p>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon purple">
                    <i class="fas fa-weight-hanging"></i>
                </div>
                <h3 id="totalWeight">0</h3>
                <p>T·ªïng kh·ªëi l∆∞·ª£ng (t·∫•n)</p>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="fas fa-arrow-right"></i>
                </div>
                <h3 id="todayIn">0</h3>
                <p>Xe v√†o h√¥m nay</p>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h3 id="todayOut">0</h3>
                <p>Xe ra h√¥m nay</p>
            </div>
        </div>

        <!-- Filter Section - VIP Pro -->
        <div class="filter-section">
            <h3><i class="fas fa-sliders-h"></i> B·ªô L·ªçc T√¨m Ki·∫øm N√¢ng Cao</h3>
            
            <div class="alert alert-info" role="alert" style="margin-bottom: 20px; border-left: 4px solid #2980b9; border-radius: 8px; padding: 15px; background: linear-gradient(135deg, rgba(41, 128, 185, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%);">
                <i class="fas fa-info-circle" style="color: #2980b9;"></i> <strong>L∆∞u √Ω:</strong> M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã d·ªØ li·ªáu h√¥m nay. ƒê·ªÉ xem t·∫•t c·∫£ d·ªØ li·ªáu, ƒë·ªÉ tr·ªëng √¥ "Ch·ªçn ng√†y" ho·∫∑c click n√∫t "Xem t·∫•t c·∫£" b√™n d∆∞·ªõi.
            </div>

            <div class="filter-row">
                <div class="form-group">
                    <label for="plateFilter" style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-car-side" style="color: #27ae60;"></i> Bi·ªÉn s·ªë xe
                    </label>
                    <input type="text" id="plateFilter" class="form-control" placeholder="V√≠ d·ª•: 29A-12345" style="border: 2px solid #e0e0e0; border-radius: 12px;">
                </div>
                <div class="form-group">
                    <label for="dateFilter" style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-calendar-alt" style="color: #2980b9;"></i> Ch·ªçn ng√†y
                    </label>
                    <input type="date" id="dateFilter" class="form-control" style="border: 2px solid #e0e0e0; border-radius: 12px;">
                </div>
                <div class="form-group">
                    <label for="directionFilter" style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-arrows-alt-h" style="color: #e74c3c;"></i> H∆∞·ªõng
                    </label>
                    <select id="directionFilter" class="form-control select-custom">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="IN">üëâ V√†o</option>
                        <option value="OUT">üëà Ra</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-filter" onclick="filterRecords()" style="width: 100%;">
                        <i class="fas fa-search"></i> <span>T√¨m ki·∫øm</span>
                    </button>
                </div>
            </div>

            <!-- Buttons v√† M·ªü r·ªông - C√πng 1 h√†ng -->
            <div class="btn-group-custom">
                <button class="btn btn-secondary" onclick="clearFilters()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); border: none; color: white;">
                    <i class="fas fa-redo"></i> <span>Reset</span>
                </button>
                <button class="btn btn-info" onclick="viewAllRecords()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none; color: white;">
                    <i class="fas fa-list"></i> <span>Xem t·∫•t c·∫£</span>
                </button>
                <button class="btn" onclick="exportData()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; color: white;">
                    <i class="fas fa-download"></i> <span>Xu·∫•t Excel</span>
                </button>
                <button class="advanced-toggle" onclick="toggleAdvancedFilters()">
                    <i class="fas fa-cog"></i> <span id="advancedToggleText">M·ªü r·ªông</span> <i class="fas fa-chevron-down" id="advancedToggleIcon"></i>
                </button>
            </div>

            <!-- Advanced Filters -->
            <div class="advanced-filters" id="advancedFilters">
                <div class="filter-advanced-row">
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-sort-amount-down" style="color: #2980b9;"></i> S·∫Øp x·∫øp
                        </label>
                        <select id="sortFilter" class="form-control select-custom">
                            <option value="time_desc">M·ªõi nh·∫•t ‚Üí C≈© nh·∫•t</option>
                            <option value="time_asc">C≈© nh·∫•t ‚Üí M·ªõi nh·∫•t</option>
                            <option value="weight_desc">Tr·ªçng l∆∞·ª£ng: Cao ‚Üí Th·∫•p</option>
                            <option value="weight_asc">Tr·ªçng l∆∞·ª£ng: Th·∫•p ‚Üí Cao</option>
                            <option value="plate_asc">Bi·ªÉn s·ªë: A ‚Üí Z</option>
                            <option value="plate_desc">Bi·ªÉn s·ªë: Z ‚Üí A</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-weight" style="color: #e74c3c;"></i> Tr·ªçng l∆∞·ª£ng t·ª´ (t·∫•n)
                        </label>
                        <input type="number" id="weightMin" class="form-control" placeholder="0" step="0.1" style="border: 2px solid #e0e0e0; border-radius: 12px;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-weight" style="color: #c0392b;"></i> Tr·ªçng l∆∞·ª£ng ƒë·∫øn (t·∫•n)
                        </label>
                        <input type="number" id="weightMax" class="form-control" placeholder="100" step="0.1" style="border: 2px solid #e0e0e0; border-radius: 12px;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-list-ol" style="color: #11998e;"></i> S·ªë l∆∞·ª£ng hi·ªÉn th·ªã
                        </label>
                        <select id="limitFilter" class="form-control select-custom">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="10">10 b·∫£n ghi</option>
                            <option value="20">20 b·∫£n ghi</option>
                            <option value="50">50 b·∫£n ghi</option>
                            <option value="100">100 b·∫£n ghi</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <h3><i class="fas fa-list"></i> K·∫øt Qu·∫£ T√¨m Ki·∫øm</h3>
                <span class="results-count" id="resultsCount">0 k·∫øt qu·∫£</span>
            </div>
            <div class="table-container" id="resultsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('access_token');
        }

        // Get headers with auth
        function getAuthHeaders() {
            const token = getAuthToken();
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        }

        // Check authentication
        function checkAuth() {
            if (!getAuthToken()) {
                window.location.href = '/login';
                return;
            }
        }

        // Load stats and initial data
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Set today's date as default in the date filter
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            document.getElementById('dateFilter').value = todayStr;
            
            // Load stats
            loadStats();
            
            // Load today's records by default
            loadRecords(todayStr);
        });

        function loadStats() {
            fetch('/api/stats', {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        // Card g·ªôp: T·ªïng s·ªë ghi h√¥m nay / T·ªïng s·ªë ghi
                        document.getElementById('todayRecords').textContent = data.today_records || 0;
                        document.getElementById('totalRecords').textContent = data.total_records || 0;
                        
                        document.getElementById('uniquePlates').textContent = data.unique_plates || 0;
                        document.getElementById('totalWeight').textContent = data.total_weight ? data.total_weight.toFixed(2) : '0.00';
                        document.getElementById('todayIn').textContent = data.today_in || 0;
                        document.getElementById('todayOut').textContent = data.today_out || 0;
                    }
                })
                .catch(error => console.error('Error loading stats:', error));
        }

        function toggleAdvancedFilters() {
            const filters = document.getElementById('advancedFilters');
            const toggleText = document.getElementById('advancedToggleText');
            const toggleIcon = document.getElementById('advancedToggleIcon');
            
            filters.classList.toggle('show');
            if (filters.classList.contains('show')) {
                toggleText.textContent = 'Thu g·ªçn';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                toggleText.textContent = 'M·ªü r·ªông';
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
        }


        function loadRecords(date = '', licensePlate = '', direction = '', sort = '', weightMin = '', weightMax = '', limit = '') {
            let url = '/api/records';
            const params = new URLSearchParams();
            if (date) params.append('date', date);
            if (licensePlate) params.append('license_plate', licensePlate);
            if (direction) params.append('direction', direction);
            if (sort) params.append('sort', sort);
            if (weightMin) params.append('weight_min', weightMin);
            if (weightMax) params.append('weight_max', weightMax);
            if (limit) params.append('limit', limit);
            if (params.toString()) url += '?' + params.toString();

            fetch(url, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) displayRecords(data);
                })
                .catch(error => {
                    console.error('Error loading records:', error);
                    document.getElementById('resultsContainer').innerHTML = 
                        '<div class="no-results"><i class="fas fa-exclamation-triangle"></i><h4>L·ªói k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu</h4></div>';
                });
        }

        function displayRecords(records) {
            const container = document.getElementById('resultsContainer');
            document.getElementById('resultsCount').textContent = records.length + ' k·∫øt qu·∫£';

            if (records.length === 0) {
                container.innerHTML = '<div class="no-results"><i class="fas fa-search"></i><h4>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h4><p>H√£y th·ª≠ c√°c b·ªô l·ªçc kh√°c</p></div>';
                return;
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Th·ªùi gian</th>
                            <th>H∆∞·ªõng</th>
                            <th>Bi·ªÉn s·ªë</th>
                            <th>Kh·ªëi l∆∞·ª£ng (t·∫•n)</th>
                            <th>Thi·∫øt b·ªã</th>
                            <th>Xem ·∫£nh</th>
                            <th>Th√¥ng tin th√™m</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            records.forEach(record => {
                // S·ª≠ d·ª•ng capture_time thay v√¨ capture_date
                const timeStr = record.capture_time || record.capture_date || '';
                let dateStr = 'N/A';
                
                if (timeStr) {
                    try {
                        const date = new Date(timeStr);
                        if (!isNaN(date.getTime())) {
                            dateStr = date.toLocaleString('vi-VN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        }
                    } catch (e) {
                        dateStr = timeStr; // N·∫øu parse l·ªói, hi·ªÉn th·ªã raw string
                    }
                }
                
                // Hi·ªÉn th·ªã direction (v√†o/ra)
                const direction = record.direction || 'N/A';
                const directionBadge = direction === 'IN' 
                    ? '<span style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">üëâ V√ÄO</span>'
                    : direction === 'OUT'
                    ? '<span style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">üëà RA</span>'
                    : '<span style="color: #7f8c8d;">N/A</span>';
                
                html += `
                    <tr>
                        <td><span class="badge-custom primary">#${record.id}</span></td>
                        <td><strong>${dateStr}</strong></td>
                        <td>${directionBadge}</td>
                        <td><strong style="color: #27ae60; font-size: 1.1rem;">${record.license_plate}</strong></td>
                        <td><strong style="color: #e74c3c; font-size: 1.05rem;">${record.vehicle_weight ? record.vehicle_weight + ' t·∫•n' : 'N/A'}</strong></td>
                        <td>${record.device_id || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewImage('${record.image_path || ''}', '${record.license_plate}')" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-image"></i> Xem ·∫£nh
                            </button>
                        </td>
                        <td>${record.notes || record.additional_info || '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function filterRecords() {
            const date = document.getElementById('dateFilter').value;
            const licensePlate = document.getElementById('plateFilter').value;
            const direction = document.getElementById('directionFilter').value;
            const sort = document.getElementById('sortFilter').value;
            const weightMin = document.getElementById('weightMin').value;
            const weightMax = document.getElementById('weightMax').value;
            const limit = document.getElementById('limitFilter').value;
            
            document.getElementById('resultsContainer').innerHTML = 
                '<div class="loading"><div class="spinner"></div><p>ƒêang t√¨m ki·∫øm...</p></div>';
            
            loadRecords(date, licensePlate, direction, sort, weightMin, weightMax, limit);
        }

        function exportData() {
            alert('T√≠nh nƒÉng xu·∫•t Excel ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng s·ª≠ d·ª•ng t√≠nh nƒÉng Copy/Paste t·ª´ b·∫£ng.');
        }

        function viewAllRecords() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('plateFilter').value = '';
            document.getElementById('directionFilter').value = '';
            document.getElementById('sortFilter').value = 'time_desc';
            document.getElementById('weightMin').value = '';
            document.getElementById('weightMax').value = '';
            document.getElementById('limitFilter').value = '';
            
            document.getElementById('resultsContainer').innerHTML = 
                '<div class="loading"><div class="spinner"></div><p>ƒêang t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu...</p></div>';
            
            loadRecords('', '', '', 'time_desc', '', '', '');
        }

        function clearFilters() {
            // Reset to today's date
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('dateFilter').value = todayStr;
            document.getElementById('plateFilter').value = '';
            document.getElementById('directionFilter').value = '';
            document.getElementById('sortFilter').value = 'time_desc';
            document.getElementById('weightMin').value = '';
            document.getElementById('weightMax').value = '';
            document.getElementById('limitFilter').value = '';
            
            // Thu g·ªçn advanced filters
            const advancedFilters = document.getElementById('advancedFilters');
            if (advancedFilters.classList.contains('show')) {
                toggleAdvancedFilters();
            }
            
            document.getElementById('resultsContainer').innerHTML = 
                '<div class="loading"><div class="spinner"></div><p>ƒêang t·∫£i d·ªØ li·ªáu...</p></div>';
            loadRecords(todayStr);
            loadStats();
        }

        function viewImage(imagePath, licensePlate) {
            // Ki·ªÉm tra n·∫øu imagePath r·ªóng ho·∫∑c kh√¥ng h·ª£p l·ªá
            if (!imagePath || imagePath.trim() === '') {
                alert('Kh√¥ng c√≥ ƒë∆∞·ªùng d·∫´n ·∫£nh ƒë·ªÉ hi·ªÉn th·ªã!');
                return;
            }

            // X·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n ·∫£nh - h·ªó tr·ª£ c·∫£ URL ƒë·∫ßy ƒë·ªß v√† ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi
            let imageUrl = imagePath.trim();
            
            // N·∫øu l√† ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi (b·∫Øt ƒë·∫ßu b·∫±ng /uploads), th√™m domain
            if (imageUrl.startsWith('/uploads/')) {
                imageUrl = window.location.origin + imageUrl;
            }
            // N·∫øu l√† URL ƒë·∫ßy ƒë·ªß (http/https), gi·ªØ nguy√™n
            // N·∫øu kh√¥ng, th·ª≠ d√πng tr·ª±c ti·∫øp

            // T·∫°o modal ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh
            const modal = `
                <div id="imageModal" class="image-modal-overlay">
                    <div class="image-modal-content">
                        <div class="image-modal-header">
                            <div class="image-modal-title">
                                <i class="fas fa-car"></i> Bi·ªÉn s·ªë: ${licensePlate || 'N/A'}
                            </div>
                            <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
                        </div>
                        <div class="image-modal-body">
                            <img id="modalImage" src="${imageUrl}" 
                                onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect width=\'400\' height=\'300\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' fill=\'%23999\' font-size=\'18\'%3E·∫¢nh kh√¥ng t√¨m th·∫•y ho·∫∑c kh√¥ng th·ªÉ t·∫£i%3C/text%3E%3C/svg%3E'; document.getElementById('imageError').style.display='block';"
                                onload="document.getElementById('imageLoading').style.display='none';">
                            <div id="imageLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div class="spinner" style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #27ae60; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                                <p style="color: #7f8c8d;">ƒêang t·∫£i ·∫£nh...</p>
                            </div>
                            <div id="imageError" style="display: none; text-align: center; color: #e74c3c; margin-top: 10px;">
                                <i class="fas fa-exclamation-triangle"></i> Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ ƒë∆∞·ªùng d·∫´n n√†y
                            </div>
                        </div>
                        <div class="image-modal-footer">
                            <p>${imagePath}</p>
                            <a href="${imageUrl}" target="_blank">
                                <i class="fas fa-external-link-alt"></i> M·ªü ·∫£nh trong tab m·ªõi
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('imageModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // ·∫®n loading sau khi ·∫£nh t·∫£i xong ho·∫∑c sau 5 gi√¢y
            setTimeout(() => {
                const loading = document.getElementById('imageLoading');
                if (loading) loading.style.display = 'none';
            }, 5000);
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // ƒê√≥ng modal khi click ra ngo√†i (ch·ªâ khi click v√†o overlay, kh√¥ng ph·∫£i content)
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('imageModal');
            if (modal && event.target === modal) {
                closeImageModal();
            }
        });

        // ƒê√≥ng modal khi nh·∫•n ph√≠m ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
</body>
</html>

